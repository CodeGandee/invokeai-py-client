# InvokeAI Python Client – Code Review of src/ against design

Scope
- Code under [src/](src/:1)
- Design criteria in [context/tasks/task-check-design.md](context/tasks/task-check-design.md:1)
- Review workflow per [.magic-context/instructions/review-code-by-mem.md](.magic-context/instructions/review-code-by-mem.md:1)
- Supporting samples: [data/workflows/](data/workflows/:1), [data/api-calls/](data/api-calls/:1)
- README submission contract: [README.md](README.md:171)

Executive summary
Overall the implementation aligns well with the intended workflow-centric design: it preserves raw workflow JSON, discovers inputs from the form tree, tracks JSONPaths, and builds minimal submission graphs with nodes/edges. Repositories are cleanly isolated; the field system is broadly type-safe and default-constructable in most cases. There are several material deviations and refinements recommended:

High-priority remediation
1) JSONPath target should point to ...inputs.{field}.value and updates must be value-only (no new keys). Current logic targets the field dict (not .value) and merges dictionaries, which can introduce extra keys and fail to update nested values for some field types.

2) ModelIdentifierField serialization contract should return {"value": {...}} to match the GUI-exported schema and the API-node extraction logic. Current implementation returns top-level keys (key/hash/name/...), which will not update existing "value" and may yield stale models in submission.

3) Default-constructability: IvkModelIdentifierField requires required fields with no defaults, violating the strict requirement that ALL IvkField subclasses are default-constructable.

Important design clarifications or doc alignment
4) Pruning of edge-connected inputs: README prescribes pruning; code retains them by default (with an env var to prune). Either align the README with the current pragmatic behavior (recommended) or invert the default and prune by default if API parity requires it.

5) Board injection is broader than spec (applies to flux_vae_encode/decode and hed_edge_detection). Consider scoping to output nodes (save_image, l2i) per README unless more nodes are intended.

Strengths observed
- Raw JSON preservation with safe copies: [WorkflowDefinition.from_file()](src/invokeai_py_client/workflow/workflow_model.py:117), [WorkflowDefinition.from_dict()](src/invokeai_py_client/workflow/workflow_model.py:158), and [WorkflowDefinition.to_dict()](src/invokeai_py_client/workflow/workflow_model.py:195) preserve the original JSON for faithful minimal mutation.

- Inputs discovered from form tree, not exposedFields: [WorkflowHandle._initialize_inputs()](src/invokeai_py_client/workflow/workflow_handle.py:181) correctly traverses form.elements starting at root and collects node-field entries, matching the design note to ignore exposedFields.

- Field type locking for safety: [IvkWorkflowInput._lock_field_type()](src/invokeai_py_client/workflow/workflow_handle.py:83) enforces exact field type (not even subclasses), reducing semantic drift in downstream processing.

- Submission graph assembly: [WorkflowHandle._convert_to_api_format()](src/invokeai_py_client/workflow/workflow_handle.py:1447) extracts a minimal node graph, normalizes board, converts GUI edges to API edges, and packages batch payload in [submit_sync()](src/invokeai_py_client/workflow/workflow_handle.py:618)/[submit()](src/invokeai_py_client/workflow/workflow_handle.py:728).

- Async monitoring + event streaming: Socket.IO integrations in [WorkflowHandle.submit()](src/invokeai_py_client/workflow/workflow_handle.py:728), [wait_for_completion()](src/invokeai_py_client/workflow/workflow_handle.py:999), and streaming helper [submit_sync_monitor_async()](src/invokeai_py_client/workflow/workflow_handle.py:1096) match the intended real-time monitoring.

- DNN model repo uses v2 traversal as documented: [DnnModelRepository.list_models()](src/invokeai_py_client/dnn_model/dnn_model_repo.py:59) and [get_model_by_key()](src/invokeai_py_client/dnn_model/dnn_model_repo.py:102) call '/../v2/models', matching [README.md](README.md:149).

Design criteria conformance checklist

A) Treat exported GUI workflow JSON as source of truth and keep it unmodified
- Conformance: Strong.
  - Raw JSON preserved via [WorkflowDefinition.raw_data](src/invokeai_py_client/workflow/workflow_model.py:92), copied on conversion in [_convert_to_api_format()](src/invokeai_py_client/workflow/workflow_handle.py:1447).
  - Concern: Merging non-value keys during field updates may add keys to the copied working JSON. The original is preserved, but the working copy can diverge structurally from the GUI schema.

B) Input discovery from form tree; ignore exposedFields
- Conformance: Strong.
  - Inputs traversed only from form.elements starting at 'root' ([WorkflowHandle._initialize_inputs()](src/invokeai_py_client/workflow/workflow_handle.py:181)).
  - exposedFields present in [WorkflowDefinition](src/invokeai_py_client/workflow/workflow_model.py:85) but unused.

C) Record JSONPath for each input pointing to the dict to be overwritten by to_api_format(); NEVER add/remove keys; only modify values
- Partial conformance; important deviation:
  - The stored JSONPath points to inputs.{field} (the field object), not to inputs.{field}.value ([WorkflowHandle._initialize_inputs() → jsonpath_expr](src/invokeai_py_client/workflow/workflow_handle.py:241)).
  - Overwrite strategy merges dicts: existing + api_format ([WorkflowHandle._convert_to_api_format()](src/invokeai_py_client/workflow/workflow_handle.py:1469)), which can (a) add keys like "type"/"choices" for enums and (b) fail to update nested "value" for model fields since IvkModelIdentifierField returns top-level keys, not "value".
  - This violates the strict "modify only values" principle and the stated JSONPath contract in [README.md](README.md:176) which prescribes pointing to ...inputs.{field}.value.

D) Deterministic input ordering (depth-first traversal)
- Conformance: Good.
  - Traversal depth-first order through container children yields stable indices ([WorkflowHandle._initialize_inputs()](src/invokeai_py_client/workflow/workflow_handle.py:195)).

E) Heuristic type inference tolerant to new/unrecognized types
- Conformance: Good.
  - [_detect_field_type()](src/invokeai_py_client/workflow/workflow_handle.py:372) checks field_info.type, field names, node type, runtime values, and constraints; defaults to string.

F) Build minimal API graph and craft batch
- Partial conformance with documented divergence:
  - The README's “omit inputs fed by edges” is not default: code keeps connected fields unless env var INVOKEAI_PRUNE_CONNECTED_FIELDS=1 ([WorkflowHandle._convert_to_api_format()](src/invokeai_py_client/workflow/workflow_handle.py:1494)).
  - Comments justify keeping them because GUI payloads commonly include both; this likely improves compatibility in practice.

G) Board injection for outputs
- Conformance with broader application:
  - Normalizes existing board fields and sets board for output-ish nodes (save_image, l2i) and additionally flux_vae_decode/flux_vae_encode/hed_edge_detection ([WorkflowHandle._convert_to_api_format()](src/invokeai_py_client/workflow/workflow_handle.py:1557)).
  - Consider reconciling this with README that referenced only 'save_image' and